AWSTemplateFormatVersion: 2010-09-09
Description: Development management infrastructure provision by this 'CloudFormation' template.
  This template may refer some external template to orchestrate application specific environment 
  and resource setup.

Parameters:
  RepositoryLocationParameter:
    Type: String
    Default: https://github.com/sachithdickwella/insight-watch-client.git
    ConstraintDescription: Code build source repository location parameter. Preferably, should be a code
      repository URL.
  RepositoryArtifactsPath:
    Type: String
    Default: "Snapshots"
    ConstraintDescription: Development artifact path in the S3 bucket.

Resources:
  CloudBuild:
    Type: AWS::CodeBuild::Project
    DependsOn: GitHubSourceCredential
    Properties:
      Name: CloudBuildPipeline
      Description: Repository's build pipeline which deploy artifacts to the maven repository.
      Artifacts:
        Type: S3
        Location: !Ref BuildArtifactTargetBucket
        OverrideArtifactName: true
        Name: "/"
        NamespaceType: BUILD_ID
        Path: !Ref RepositoryArtifactsPath
      Environment:
        Type: LINUX_CONTAINER
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/standard:4.0
        PrivilegedMode: true
      ServiceRole: !Ref CodeBuildAccessRole
      Source:
        Type: GITHUB
        Location: !Ref RepositoryLocationParameter
        GitCloneDepth: 1
        ReportBuildStatus: true
        GitSubmodulesConfig:
          FetchSubmodules: true
        BuildSpec: |
          version: 0.2
          phases:
            install:
              runtime-versions:
                java: corretto19
            pre_build:
              commands:
                - mvn -version
                - cd source/insight-watch-client
            build:
              commands:
                - echo "Build started on `date`."
                - mvn -T 1.5C install
            post_build:
              commands:
                - echo "Entered the post_build phase..."
                - echo "Build completed on `date`."
          artifacts:
            files:
              - "**/*.jar"
            discard-paths: yes
          cache:
            paths:
              - "/root/.m2/**/*"
      BadgeEnabled: false
      LogsConfig:
        CloudWatchLogs:
          GroupName: !Ref CodeBuildLogGroup
          Status: ENABLED

  CodeBuildAccessRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - "codebuild.amazonaws.com"
            Action:
              - 'sts:AssumeRole'
      Description: IAM role for the CodeBuild project to access resources.
      Policies:
        - PolicyName: CodeBuildAccessRolePolicy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Resource:
                  - Fn::Join:
                      - ""
                      - - !GetAtt [BuildArtifactTargetBucket, Arn]
                  - Fn::Join:
                      - ""
                      - - !GetAtt [BuildArtifactTargetBucket, Arn]
                        - "/*"
                Action:
                  - "s3:PutObject"
                  - "s3:GetObject"
                  - "s3:GetObjectVersion"
                  - "s3:GetBucketAcl"
                  - "s3:GetBucketLocation"

              - Effect: Allow
                Resource:
                  - Fn::Join:
                      - ""
                      - - !GetAtt [CodeBuildLogGroup, Arn]
                  - Fn::Join:
                      - ""
                      - - !GetAtt [CodeBuildLogGroup, Arn]
                        - "/*"
                Action:
                  - "logs:CreateLogStream"
                  - "logs:PutLogEvents"

  CodeBuildLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: "CodeBuildLogGroup"
      RetentionInDays: 30

  BuildArtifactTargetBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      BucketName: !Sub 'maven-artifacts-${AWS::Region}'
      AccessControl: Private # Default

  GitHubSourceCredential:
    Type: AWS::CodeBuild::SourceCredential
    Properties:
      AuthType: PERSONAL_ACCESS_TOKEN
      ServerType: GITHUB
      Token: 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
